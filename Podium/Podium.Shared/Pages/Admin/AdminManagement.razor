@page "/admin/admins"
@using Podium.Shared.Services.State
@using Podium.Shared.Services.Api
@using Podium.Shared.Models
@using Podium.Shared.Components.Admin
@inject AuthStateService AuthState
@inject AdminStateService AdminState
@inject NavigationManager Navigation
@inject IPodiumApiClient ApiClient

<PageTitle>Manage Administrators - Admin</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h1>?? Manage Administrators</h1>
        <button class="btn btn-primary" @onclick="ShowCreateForm">+ Add Administrator</button>
    </div>

    @if (loading)
    {
        <div class="loading">Loading administrators...</div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-error">@errorMessage</div>
    }
    else
    {
        @if (showForm)
        {
            <div class="admin-form">
                <h3>@(editingAdmin == null ? "Create" : "Edit") Administrator</h3>
                
                @if (editingAdmin == null)
                {
                    <div class="form-group">
                        <label>Search User:</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="searchQuery" 
                               @bind:event="oninput"
                               @onkeyup="SearchUsers"
                               placeholder="Type username or email..." />
                        
                        @if (searchResults.Any())
                        {
                            <div class="search-results">
                                @foreach (var user in searchResults)
                                {
                                    <div class="search-result-item" @onclick="() => SelectUser(user)">
                                        <strong>@user.Username</strong> (@user.Email)
                                        <span class="badge @(user.IsActive ? "badge-success" : "badge-inactive")">
                                            @(user.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                        
                        @if (selectedUser != null)
                        {
                            <div class="selected-user">
                                <strong>Selected:</strong> @selectedUser.Username (@selectedUser.Email)
                                <button class="btn-link" @onclick="ClearSelection">Clear</button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="form-group">
                        <label>User:</label>
                        <div class="user-display">
                            <strong>@GetUserDisplay(editingAdmin.UserId)</strong>
                        </div>
                    </div>
                }
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" @bind="formIsActive" />
                        Active (can access admin features)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" @bind="formCanManageAdmins" />
                        Can Manage Admins (can create/edit/remove other admins)
                    </label>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                    <button class="btn btn-primary" 
                            @onclick="SaveAdmin" 
                            disabled="@(saving || (editingAdmin == null && selectedUser == null))">
                        @(saving ? "Saving..." : "Save")
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(formError))
                {
                    <div class="alert alert-error">@formError</div>
                }
            </div>
        }

        <div class="admin-table">
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Can Manage Admins</th>
                        <th>Created</th>
                        <th>Created By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var admin in admins)
                    {
                        <tr>
                            <td>@GetUsername(admin.UserId)</td>
                            <td>@GetEmail(admin.UserId)</td>
                            <td>
                                <span class="badge @(admin.IsActive ? "badge-success" : "badge-inactive")">
                                    @(admin.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td>
                                @if (admin.CanManageAdmins)
                                {
                                    <span class="badge badge-success">Yes</span>
                                }
                                else
                                {
                                    <span class="badge badge-inactive">No</span>
                                }
                            </td>
                            <td>@admin.CreatedDate.ToShortDateString()</td>
                            <td>
                                @if (admin.CreatedBy == "System")
                                {
                                    <span>System</span>
                                }
                                else
                                {
                                    <a href="/admin/users/@admin.CreatedBy" class="user-link">
                                        @GetCreatedByUsername(admin.CreatedBy)
                                    </a>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" @onclick="() => EditAdmin(admin)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(admin)" 
                                        disabled="@(admin.UserId == AuthState.UserId)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<ConfirmDialog IsVisible="showDeleteConfirm"
               Title="Remove Administrator"
               Message="@($"Are you sure you want to remove admin privileges for {GetUsername(adminToDelete?.UserId ?? "")}?")"
               ConfirmText="Remove"
               OnConfirm="DeleteAdmin"
               OnCancel="CancelDelete" />

@code {
    private List<Admin> admins = new();
    private Dictionary<string, User> userCache = new();
    private List<UserSearchResult> searchResults = new();
    private UserSearchResult? selectedUser = null;
    private bool loading = true;
    private bool saving = false;
    private bool showForm = false;
    private bool showDeleteConfirm = false;
    private string errorMessage = "";
    private string formError = "";
    private string searchQuery = "";

    private Admin? editingAdmin = null;
    private Admin? adminToDelete = null;
    private bool formIsActive = true;
    private bool formCanManageAdmins = false;

    protected override async Task OnInitializedAsync()
    {
        if (!AdminState.IsInitialized)
        {
            await AdminState.InitializeAsync();
        }

        if (!AdminState.CanManageAdmins)
        {
            Navigation.NavigateTo("/admin");
            return;
        }

        await LoadAdmins();
        await LoadUserDetails();
    }

    private async Task LoadAdmins()
    {
        loading = true;
        errorMessage = "";
        var response = await ApiClient.GetAllAdminsAsync();
        
        if (response.Success && response.Data != null)
        {
            admins = response.Data;
        }
        else
        {
            errorMessage = response.Error ?? "Failed to load administrators";
        }
        
        loading = false;
    }

    private async Task LoadUserDetails()
    {
        // Load user details for all admins and their creators
        var userIdsToLoad = new HashSet<string>();
        
        foreach (var admin in admins)
        {
            userIdsToLoad.Add(admin.UserId);
            if (!string.IsNullOrEmpty(admin.CreatedBy) && admin.CreatedBy != "System")
            {
                userIdsToLoad.Add(admin.CreatedBy);
            }
        }

        foreach (var userId in userIdsToLoad)
        {
            if (!userCache.ContainsKey(userId))
            {
                var response = await ApiClient.GetUserAdminAsync(userId);
                if (response.Success && response.Data != null)
                {
                    userCache[userId] = response.Data;
                }
            }
        }
        StateHasChanged();
    }

    private string GetUsername(string userId)
    {
        return userCache.TryGetValue(userId, out var user) ? user.Username : userId;
    }

    private string GetEmail(string userId)
    {
        return userCache.TryGetValue(userId, out var user) ? user.Email : "Loading...";
    }

    private string GetCreatedByUsername(string userId)
    {
        if (string.IsNullOrEmpty(userId) || userId == "System")
            return "System";
        return userCache.TryGetValue(userId, out var user) ? user.Username : userId;
    }

    private string GetUserDisplay(string userId)
    {
        if (userCache.TryGetValue(userId, out var user))
        {
            return $"{user.Username} ({user.Email})";
        }
        return userId;
    }

    private async Task SearchUsers()
    {
        if (string.IsNullOrWhiteSpace(searchQuery) || searchQuery.Length < 2)
        {
            searchResults.Clear();
            return;
        }

        var response = await ApiClient.SearchUsersAsync(searchQuery);
        if (response.Success && response.Data != null)
        {
            searchResults = response.Data.Take(10).ToList();
        }
        else
        {
            searchResults.Clear();
        }
    }

    private void SelectUser(UserSearchResult user)
    {
        selectedUser = user;
        searchResults.Clear();
        searchQuery = "";
    }

    private void ClearSelection()
    {
        selectedUser = null;
        searchQuery = "";
    }

    private void ShowCreateForm()
    {
        editingAdmin = null;
        selectedUser = null;
        searchQuery = "";
        searchResults.Clear();
        formIsActive = true;
        formCanManageAdmins = false;
        formError = "";
        showForm = true;
    }

    private void EditAdmin(Admin admin)
    {
        editingAdmin = admin;
        formIsActive = admin.IsActive;
        formCanManageAdmins = admin.CanManageAdmins;
        formError = "";
        showForm = true;
    }

    private void CancelForm()
    {
        showForm = false;
        editingAdmin = null;
        selectedUser = null;
        searchQuery = "";
        searchResults.Clear();
        formError = "";
    }

    private async Task SaveAdmin()
    {
        if (editingAdmin == null && selectedUser == null)
        {
            formError = "Please select a user";
            return;
        }

        saving = true;
        formError = "";

        if (editingAdmin == null && selectedUser != null)
        {
            // Create
            var response = await ApiClient.CreateAdminAsync(selectedUser.UserId, formIsActive, formCanManageAdmins);
            
            if (response.Success)
            {
                await LoadAdmins();
                await LoadUserDetails();
                CancelForm();
            }
            else
            {
                formError = response.Error ?? "Failed to create administrator";
            }
        }
        else if (editingAdmin != null)
        {
            // Update
            var response = await ApiClient.UpdateAdminAsync(editingAdmin.UserId, formIsActive, formCanManageAdmins);
            
            if (response.Success)
            {
                await LoadAdmins();
                CancelForm();
            }
            else
            {
                formError = response.Error ?? "Failed to update administrator";
            }
        }

        saving = false;
    }

    private void ConfirmDelete(Admin admin)
    {
        adminToDelete = admin;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        adminToDelete = null;
    }

    private async Task DeleteAdmin()
    {
        if (adminToDelete == null) return;

        var response = await ApiClient.RemoveAdminAsync(adminToDelete.UserId);
        
        showDeleteConfirm = false;
        
        if (response.Success)
        {
            await LoadAdmins();
        }
        else
        {
            errorMessage = response.Error ?? "Failed to remove administrator";
        }
        
        adminToDelete = null;
    }
}
