@page "/admin/competitors"
@page "/admin/competitors/{SeasonIdParam}"
@using Podium.Shared.Services.State
@using Podium.Shared.Services.Api
@using Podium.Shared.Models
@using Podium.Shared.Components.Admin
@inject AuthStateService AuthState
@inject AdminStateService AdminState
@inject NavigationManager Navigation
@inject IPodiumApiClient ApiClient
@inject IJSRuntime JS

<PageTitle>Manage Competitors - Admin</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h1><span style="font-size: 1.2em;">&#127933;&#65039;</span> Manage Competitors</h1>
        <button class="btn btn-primary" @onclick="ShowCreateForm">+ Add Competitor</button>
    </div>

    @if (loading)
    {
        <div class="loading">Loading competitors...</div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success" style="display: flex; justify-content: space-between; align-items: center;">
                <span>&#10004; @successMessage</span>
                <button class="btn btn-sm btn-secondary" @onclick="ClearSuccess">Clear &times;</button>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error" style="display: flex; justify-content: space-between; align-items: center;">
                <span>@errorMessage</span>
                <button class="btn btn-sm btn-secondary" @onclick="ClearError">Clear &times;</button>
            </div>
        }

        @if (showForm)
        {
            <div class="admin-form" id="competitorForm">
                <h3>@(editingCompetitor == null ? "Create" : "Edit") Competitor</h3>
                
                <div class="form-group">
                    <label>Type:</label>
                    <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="competitorType" value="Individual" 
                                   checked="@(formType == "Individual")"
                                   @onchange="@(() => formType = "Individual")" />
                            <span>Individual (Driver)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="competitorType" value="Team" 
                                   checked="@(formType == "Team")"
                                   @onchange="@(() => formType = "Team")" />
                            <span>Team (Constructor)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" class="form-control" @bind="formName" 
                           placeholder="e.g., Lewis Hamilton or Red Bull Racing" />
                </div>

                <div class="form-group">
                    <label>Short Name:</label>
                    <input type="text" class="form-control" @bind="formShortName" 
                           placeholder="e.g., HAM or RBR (for display)" />
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" @bind="formIsActive" />
                        Active
                    </label>
                </div>

                @if (editingCompetitor != null)
                {
                    <div class="form-group">
                        <label><strong>Current Season Assignments:</strong></label>
                        @if (assignedSeasonIds.Any())
                        {
                            <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                @foreach (var seasonId in assignedSeasonIds.ToList())
                                {
                                    var season = allSeasons.FirstOrDefault(s => s.Id == seasonId);
                                    if (season != null)
                                    {
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
                                            <span>
                                                <strong>@season.Year</strong> - @GetSeriesName(season.SeriesId) (@GetDisciplineName(season.SeriesId))
                                                @if (season.IsActive)
                                                {
                                                    <span class="badge badge-success" style="margin-left: 0.5rem;">Active</span>
                                                }
                                            </span>
                                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveSeasonAssignment(seasonId)">
                                                Remove
                                            </button>
                                        </div>
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            <p style="color: var(--text-light); margin-bottom: 1rem;">No season assignments yet.</p>
                        }

                        <label><strong>Add New Season Assignment:</strong></label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label>Discipline:</label>
                                <select class="form-control" @bind="selectedDisciplineForAssignment" @bind:after="OnAssignmentDisciplineChanged">
                                    <option value="">-- Select Discipline --</option>
                                    @foreach (var discipline in disciplines)
                                    {
                                        <option value="@discipline.Id">@discipline.DisplayName</option>
                                    }
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label>Series:</label>
                                <select class="form-control" @bind="selectedSeriesForAssignment" @bind:after="OnAssignmentSeriesChanged" 
                                        disabled="@string.IsNullOrEmpty(selectedDisciplineForAssignment)">
                                    <option value="">-- Select Series --</option>
                                    @foreach (var series in availableSeriesForAssignment)
                                    {
                                        <option value="@series.Id">@series.DisplayName</option>
                                    }
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label>Season:</label>
                                <select class="form-control" @bind="selectedSeasonForAssignment" 
                                        disabled="@string.IsNullOrEmpty(selectedSeriesForAssignment)">
                                    <option value="">-- Select Season --</option>
                                    @foreach (var season in availableSeasonsForAssignment)
                                    {
                                        <option value="@season.Id">@season.Year - @season.Name</option>
                                    }
                                </select>
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-sm btn-primary" @onclick="AddSeasonAssignment" 
                                        disabled="@string.IsNullOrEmpty(selectedSeasonForAssignment)">
                                    Add Season
                                </button>
                            </div>
                        </div>
                    </div>
                }

                <div class="form-actions">
                    <button class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveCompetitor" disabled="@saving">
                        @(saving ? "Saving..." : "Save")
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(formError))
                {
                    <div class="alert alert-error">@formError</div>
                }
            </div>
        }

        <div class="filter-section">
            <div style="flex: 1; max-width: 400px;">
                <label>Search:</label>
                <input type="text" class="form-control" @bind="searchQuery" @bind:after="FilterCompetitors" 
                       placeholder="Search by name..." />
            </div>
            <div style="flex: 1; max-width: 300px;">
                <label>Filter by Type:</label>
                <select class="form-control" @bind="selectedTypeFilter" @bind:after="FilterCompetitors">
                    <option value="">All Types</option>
                    <option value="Individual">Individuals (Drivers)</option>
                    <option value="Team">Teams (Constructors)</option>
                </select>
            </div>
            <div style="flex: 1; max-width: 400px;">
                <label>Filter by Season:</label>
                <select class="form-control" @bind="selectedSeasonFilter" @bind:after="FilterCompetitors">
                    <option value="">All Seasons</option>
                    @foreach (var season in allSeasons.OrderByDescending(s => s.Year))
                    {
                        <option value="@season.Id">@season.Year - @season.Name (@GetSeriesName(season.SeriesId))</option>
                    }
                </select>
            </div>
        </div>

        <div class="admin-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Short Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Season Assignments</th>
                        <th>Podiums</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var competitor in paginatedCompetitors)
                    {
                        <tr>
                            <td><strong>@competitor.Name</strong></td>
                            <td>@competitor.ShortName</td>
                            <td>
                                <span class="badge @(competitor.Type == "Individual" ? "badge-info" : "badge-secondary")">
                                    @competitor.Type
                                </span>
                            </td>
                            <td>
                                <span class="badge @(competitor.IsActive ? "badge-success" : "badge-inactive")">
                                    @(competitor.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td>
                                @if (competitorSeasonAssignments.ContainsKey(competitor.Id))
                                {
                                    var count = competitorSeasonAssignments[competitor.Id].Count;
                                    <small style="color: #2563eb;">
                                        <strong>Seasons:</strong> @count
                                    </small>
                                }
                                else
                                {
                                    <small style="color: #6b7280;">None</small>
                                }
                            </td>
                            <td>
                                @if (competitorDependencies.ContainsKey(competitor.Id))
                                {
                                    var deps = competitorDependencies[competitor.Id];
                                    <small>
                                        @if (deps.ResultCount > 0)
                                        {
                                            <span style="color: #10b981;">
                                                <strong>@deps.ResultCount</strong> podiums
                                            </span>
                                        }
                                        else
                                        {
                                            <span style="color: #6b7280;">None</span>
                                        }
                                    </small>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" @onclick="() => EditCompetitor(competitor)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(competitor)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (!filteredCompetitors.Any())
            {
                <div class="no-results">
                    <p>No competitors found. @(string.IsNullOrEmpty(searchQuery) && string.IsNullOrEmpty(selectedTypeFilter) ? "Create one to get started!" : "Try adjusting your filters.")</p>
                </div>
            }
        </div>

        @if (totalPages > 1)
        {
            <div class="pagination">
                <button class="btn btn-secondary" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                    &laquo; Previous
                </button>
                <span style="margin: 0 1rem;">
                    Page @currentPage of @totalPages (@filteredCompetitors.Count total)
                </span>
                <button class="btn btn-secondary" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                    Next &raquo;
                </button>
            </div>
        }
    }
</div>

<ConfirmDialog IsVisible="showDeleteConfirm"
               Title="Delete Competitor"
               Message="@deleteConfirmMessage"
               ConfirmText="Delete"
               OnConfirm="DeleteCompetitor"
               OnCancel="CancelDelete" />

@code {
    private List<Discipline> disciplines = new();
    private List<Series> allSeries = new();
    private List<Season> allSeasons = new();
    private List<Competitor> allCompetitors = new();
    private List<Competitor> filteredCompetitors = new();
    private List<Competitor> paginatedCompetitors = new();
    private List<Series> availableSeriesForAssignment = new();
    private List<Season> availableSeasonsForAssignment = new();
    private Dictionary<string, CompetitorDependencies> competitorDependencies = new();
    private Dictionary<string, List<string>> competitorSeasonAssignments = new();
    private HashSet<string> assignedSeasonIds = new();
    private HashSet<string> pendingAdditions = new();
    private HashSet<string> pendingRemovals = new();

    [Parameter]
    public string? SeasonIdParam { get; set; }

    private bool loading = true;
    private bool saving = false;
    private bool showForm = false;
    private bool showDeleteConfirm = false;
    private string errorMessage = "";
    private string successMessage = "";
    private string formError = "";
    private string selectedTypeFilter = "";
    private string selectedSeasonFilter = "";
    private string searchQuery = "";
    private string deleteConfirmMessage = "";
    private string selectedDisciplineForAssignment = "";
    private string selectedSeriesForAssignment = "";
    private string selectedSeasonForAssignment = "";

    private Competitor? editingCompetitor = null;
    private Competitor? competitorToDelete = null;
    private string formName = "";
    private string formShortName = "";
    private string formType = "Individual";
    private bool formIsActive = true;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        if (!AdminState.IsInitialized)
        {
            await AdminState.InitializeAsync();
        }

        if (!AdminState.IsAdmin)
        {
            Navigation.NavigateTo("/admin");
            return;
        }

        await LoadData();
        
        // Apply season filter from URL parameter if provided
        if (!string.IsNullOrEmpty(SeasonIdParam))
        {
            selectedSeasonFilter = SeasonIdParam;
            FilterCompetitors();
        }
    }

    private async Task LoadData()
    {
        loading = true;
        errorMessage = "";

        // Load disciplines
        var disciplineResponse = await ApiClient.GetAllDisciplinesAdminAsync();
        if (disciplineResponse.Success && disciplineResponse.Data != null)
        {
            disciplines = disciplineResponse.Data;
        }

        // Load all series
        allSeries = new();
        foreach (var discipline in disciplines)
        {
            var seriesResponse = await ApiClient.GetAllSeriesAdminAsync(discipline.Id);
            if (seriesResponse.Success && seriesResponse.Data != null)
            {
                allSeries.AddRange(seriesResponse.Data);
            }
        }

        // Load all seasons
        allSeasons = new();
        foreach (var series in allSeries)
        {
            var seasonsResponse = await ApiClient.GetAllSeasonsAdminAsync(series.Id);
            if (seasonsResponse.Success && seasonsResponse.Data != null)
            {
                allSeasons.AddRange(seasonsResponse.Data);
            }
        }

        // Load all competitors
        var competitorsResponse = await ApiClient.GetAllCompetitorsAdminAsync();
        if (competitorsResponse.Success && competitorsResponse.Data != null)
        {
            allCompetitors = competitorsResponse.Data;
        }
        else
        {
            errorMessage = "Failed to load competitors";
            loading = false;
            return;
        }

        // Load dependencies and season assignments
        await LoadDependenciesAndAssignments();

        FilterCompetitors();
        loading = false;
    }

    private async Task LoadDependenciesAndAssignments()
    {
        competitorDependencies.Clear();
        competitorSeasonAssignments.Clear();

        foreach (var competitor in allCompetitors)
        {
            var depsResponse = await ApiClient.GetCompetitorDependenciesAsync(competitor.Id);
            if (depsResponse.Success && depsResponse.Data != null)
            {
                competitorDependencies[competitor.Id] = depsResponse.Data;
            }

            var seasonsResponse = await ApiClient.GetCompetitorSeasonsAsync(competitor.Id);
            if (seasonsResponse.Success && seasonsResponse.Data != null)
            {
                competitorSeasonAssignments[competitor.Id] = seasonsResponse.Data;
            }
        }
    }

    private void FilterCompetitors()
    {
        filteredCompetitors = allCompetitors;

        // Apply type filter
        if (!string.IsNullOrEmpty(selectedTypeFilter))
        {
            filteredCompetitors = filteredCompetitors.Where(c => c.Type == selectedTypeFilter).ToList();
        }

        // Apply season filter
        if (!string.IsNullOrEmpty(selectedSeasonFilter))
        {
            // Get competitor IDs that are assigned to the selected season
            var competitorsInSeason = competitorSeasonAssignments
                .Where(kvp => kvp.Value.Contains(selectedSeasonFilter))
                .Select(kvp => kvp.Key)
                .ToHashSet();
            
            filteredCompetitors = filteredCompetitors.Where(c => competitorsInSeason.Contains(c.Id)).ToList();
        }

        // Apply search
        if (!string.IsNullOrEmpty(searchQuery))
        {
            var search = searchQuery.ToLower();
            filteredCompetitors = filteredCompetitors.Where(c => 
                c.Name.ToLower().Contains(search) || 
                c.ShortName.ToLower().Contains(search)
            ).ToList();
        }

        filteredCompetitors = filteredCompetitors.OrderBy(c => c.Name).ToList();
        
        // Reset to first page when filtering
        currentPage = 1;
        UpdatePagination();
    }

    private void UpdatePagination()
    {
        totalPages = (int)Math.Ceiling(filteredCompetitors.Count / (double)pageSize);
        if (totalPages == 0) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        var skip = (currentPage - 1) * pageSize;
        paginatedCompetitors = filteredCompetitors.Skip(skip).Take(pageSize).ToList();
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagination();
        }
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagination();
        }
    }

    private string GetDisciplineName(string seriesId)
    {
        var series = allSeries.FirstOrDefault(s => s.Id == seriesId);
        if (series == null) return "Unknown";
        
        var discipline = disciplines.FirstOrDefault(d => d.Id == series.DisciplineId);
        return discipline?.DisplayName ?? "Unknown";
    }

    private string GetSeriesName(string seriesId)
    {
        var series = allSeries.FirstOrDefault(s => s.Id == seriesId);
        return series?.DisplayName ?? "Unknown";
    }

    private async Task ShowCreateForm()
    {
        editingCompetitor = null;
        formName = "";
        formShortName = "";
        formType = "Individual";
        formIsActive = true;
        formError = "";
        assignedSeasonIds = new();
        pendingAdditions = new();
        pendingRemovals = new();
        showForm = true;
        
        await ScrollToForm();
    }

    private async Task EditCompetitor(Competitor competitor)
    {
        editingCompetitor = competitor;
        formName = competitor.Name;
        formShortName = competitor.ShortName;
        formType = competitor.Type;
        formIsActive = competitor.IsActive;
        formError = "";
        pendingAdditions = new();
        pendingRemovals = new();

        // Load current season assignments
        assignedSeasonIds = new HashSet<string>();
        if (competitorSeasonAssignments.ContainsKey(competitor.Id))
        {
            foreach (var seasonId in competitorSeasonAssignments[competitor.Id])
            {
                assignedSeasonIds.Add(seasonId);
            }
        }

        // Reset assignment selectors
        selectedDisciplineForAssignment = "";
        selectedSeriesForAssignment = "";
        selectedSeasonForAssignment = "";
        availableSeriesForAssignment = new();
        availableSeasonsForAssignment = new();

        showForm = true;
        await ScrollToForm();
    }

    private async Task ScrollToForm()
    {
        await Task.Delay(100);
        await JS.InvokeVoidAsync("eval", "document.getElementById('competitorForm')?.scrollIntoView({ behavior: 'smooth', block: 'start' })");
    }

    private void OnAssignmentDisciplineChanged()
    {
        selectedSeriesForAssignment = "";
        selectedSeasonForAssignment = "";
        availableSeasonsForAssignment = new();

        if (!string.IsNullOrEmpty(selectedDisciplineForAssignment))
        {
            availableSeriesForAssignment = allSeries
                .Where(s => s.DisciplineId == selectedDisciplineForAssignment)
                .OrderBy(s => s.DisplayName)
                .ToList();
        }
        else
        {
            availableSeriesForAssignment = new();
        }
    }

    private void OnAssignmentSeriesChanged()
    {
        selectedSeasonForAssignment = "";

        if (!string.IsNullOrEmpty(selectedSeriesForAssignment))
        {
            availableSeasonsForAssignment = allSeasons
                .Where(s => s.SeriesId == selectedSeriesForAssignment && !assignedSeasonIds.Contains(s.Id))
                .OrderByDescending(s => s.Year)
                .ToList();
        }
        else
        {
            availableSeasonsForAssignment = new();
        }
    }

    private void AddSeasonAssignment()
    {
        if (!string.IsNullOrEmpty(selectedSeasonForAssignment))
        {
            assignedSeasonIds.Add(selectedSeasonForAssignment);
            pendingAdditions.Add(selectedSeasonForAssignment);
            pendingRemovals.Remove(selectedSeasonForAssignment);

            // Reset selectors
            selectedDisciplineForAssignment = "";
            selectedSeriesForAssignment = "";
            selectedSeasonForAssignment = "";
            availableSeriesForAssignment = new();
            availableSeasonsForAssignment = new();
        }
    }

    private void RemoveSeasonAssignment(string seasonId)
    {
        assignedSeasonIds.Remove(seasonId);
        pendingRemovals.Add(seasonId);
        pendingAdditions.Remove(seasonId);
    }

    private void CancelForm()
    {
        showForm = false;
        editingCompetitor = null;
        formError = "";
        pendingAdditions.Clear();
        pendingRemovals.Clear();
    }

    private void ClearError()
    {
        errorMessage = "";
    }

    private void ClearSuccess()
    {
        successMessage = "";
    }

    private async Task SaveCompetitor()
    {
        if (string.IsNullOrWhiteSpace(formName))
        {
            formError = "Name is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(formShortName))
        {
            formError = "Short name is required";
            return;
        }

        if (formType != "Individual" && formType != "Team")
        {
            formError = "Type must be Individual or Team";
            return;
        }

        saving = true;
        formError = "";
        errorMessage = "";
        successMessage = "";

        if (editingCompetitor == null)
        {
            // Create
            var request = new CreateCompetitorRequest(
                formName,
                formShortName,
                formType,
                formIsActive
            );
            var response = await ApiClient.CreateCompetitorAsync(request);
            
            
            if (response.Success)
            {
                successMessage = $"Competitor '{formName}' created successfully!";
                showForm = false;
                editingCompetitor = null;
                await LoadData();
                await ScrollToTop();
            }
            else
            {
                formError = response.Error ?? "Failed to create competitor";
            }
        }
        else
        {
            // Update competitor details
            var request = new UpdateCompetitorRequest(
                formName,
                formShortName,
                formType,
                formIsActive
            );
            var response = await ApiClient.UpdateCompetitorAsync(editingCompetitor.Id, request);
            
            if (response.Success)
            {
                // Apply season assignment changes
                await ApplySeasonChanges(editingCompetitor.Id);
                
                successMessage = $"Competitor '{formName}' updated successfully!";
                showForm = false;
                editingCompetitor = null;
                await LoadData();
                await ScrollToTop();
            }
            else
            {
                formError = response.Error ?? "Failed to update competitor";
            }
        }

        saving = false;
    }


    private async Task ApplySeasonChanges(string competitorId)
    {
        foreach (var seasonId in pendingAdditions)
        {
            var result = await ApiClient.AddCompetitorToSeasonAsync(seasonId, competitorId);
            if (!result.Success)
            {
                errorMessage = $"Warning: Failed to add some season assignments. Error: {result.Error}";
            }
        }

        foreach (var seasonId in pendingRemovals)
        {
            var result = await ApiClient.RemoveCompetitorFromSeasonAsync(seasonId, competitorId);
            if (!result.Success)
            {
                errorMessage = $"Warning: Failed to remove some season assignments. Error: {result.Error}";
            }
        }
    }

    private async Task ScrollToTop()
    {
        await Task.Delay(100);
        await JS.InvokeVoidAsync("eval", "window.scrollTo({ top: 0, behavior: 'smooth' })");
    }

    private void ConfirmDelete(Competitor competitor)
    {
        competitorToDelete = competitor;
        
        var deps = competitorDependencies.ContainsKey(competitor.Id) 
            ? competitorDependencies[competitor.Id] 
            : new CompetitorDependencies();
        
        if (deps.HasDependencies)
        {
            var reasons = new List<string>();
            if (deps.SeasonCount > 0) reasons.Add($"{deps.SeasonCount} season(s)");
            if (deps.ResultCount > 0) reasons.Add($"{deps.ResultCount} event result(s)");
            
            deleteConfirmMessage = $"Cannot delete '{competitor.Name}' because it is assigned to {string.Join(" and ", reasons)}. Please remove those assignments first.";
        }
        else
        {
            deleteConfirmMessage = $"Are you sure you want to delete '{competitor.Name}'? This action cannot be undone.";
        }
        
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        competitorToDelete = null;
    }

    private async Task DeleteCompetitor()
    {
        if (competitorToDelete == null) return;

        var deps = competitorDependencies.ContainsKey(competitorToDelete.Id) 
            ? competitorDependencies[competitorToDelete.Id] 
            : new CompetitorDependencies();

        if (deps.HasDependencies)
        {
            showDeleteConfirm = false;
            errorMessage = $"Cannot delete '{competitorToDelete.Name}' because it has dependencies.";
            competitorToDelete = null;
            return;
        }

        var name = competitorToDelete.Name;
        var response = await ApiClient.DeleteCompetitorAsync(competitorToDelete.Id, competitorToDelete.Type);
        
        showDeleteConfirm = false;
        
        if (response.Success)
        {
            successMessage = $"Competitor '{name}' deleted successfully!";
            await LoadData();
            await ScrollToTop();
        }
        else
        {
            errorMessage = response.Error ?? $"Failed to delete '{name}'";
            await ScrollToTop();
        }
        
        competitorToDelete = null;
    }
}
