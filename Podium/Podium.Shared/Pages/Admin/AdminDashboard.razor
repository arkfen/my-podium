@page "/admin"
@using Podium.Shared.Services.State
@using Podium.Shared.Services.Api
@inject AuthStateService AuthState
@inject AdminStateService AdminState
@inject NavigationManager Navigation
@inject IPodiumApiClient ApiClient

<PageTitle>Admin Dashboard - Podium</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    <div class="admin-container">
        <div class="admin-error">
            <h2>?? Authentication Required</h2>
            <p>Please sign in to access the admin dashboard.</p>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/signin"))">Sign In</button>
        </div>
    </div>
}
else if (!AdminState.IsAdmin)
{
    <div class="admin-container">
        <div class="admin-error">
            <h2>??? Access Denied</h2>
            <p>You don't have administrator privileges.</p>
            <button class="btn btn-secondary" @onclick="@(() => Navigation.NavigateTo("/"))">Back to Home</button>
        </div>
    </div>
}
else
{
    <div class="admin-container">
        <div class="admin-header">
            <h1>?? Admin Dashboard</h1>
            <p>Manage disciplines, series, seasons, competitors, and more</p>
        </div>

        <div class="admin-cards">
            <a href="/admin/disciplines" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Disciplines</h3>
                <p>Manage racing categories and disciplines</p>
            </a>

            <a href="/admin/series" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Series</h3>
                <p>Manage racing series within disciplines</p>
            </a>

            <a href="/admin/seasons" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Seasons</h3>
                <p>Manage seasons for each series</p>
            </a>

            <a href="/admin/competitors" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Competitors</h3>
                <p>Manage drivers, riders, and teams</p>
            </a>

            <a href="/admin/events" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Events</h3>
                <p>Manage races and events</p>
            </a>

            <a href="/admin/results" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Results</h3>
                <p>Enter and manage event results</p>
            </a>

            <a href="/admin/users" class="admin-card">
                <div class="card-icon">??</div>
                <h3>Users</h3>
                <p>Manage user accounts</p>
            </a>

            @if (AdminState.CanManageAdmins)
            {
                <a href="/admin/admins" class="admin-card">
                    <div class="card-icon">???</div>
                    <h3>Administrators</h3>
                    <p>Manage admin privileges</p>
                </a>
            }
        </div>

        @if (!string.IsNullOrEmpty(diagnosticMessage))
        {
            <div class="admin-diagnostics">
                <h3>?? Quick Diagnostics</h3>
                <button class="btn btn-secondary" @onclick="CheckDuplicateSeasons">Check for Duplicate Active Seasons</button>
                <div class="diagnostic-result">@diagnosticMessage</div>
            </div>
        }
    </div>
}

@code {
    private string diagnosticMessage = "";

    protected override async Task OnInitializedAsync()
    {
        if (!AdminState.IsInitialized)
        {
            await AdminState.InitializeAsync();
        }

        AdminState.OnAdminStateChanged += StateHasChanged;
    }

    private async Task CheckDuplicateSeasons()
    {
        var response = await ApiClient.FindDuplicateActiveSeasonsAsync();
        diagnosticMessage = response.Success 
            ? response.Data?.Message ?? "Check completed successfully" 
            : $"Error: {response.Error}";
        StateHasChanged();
    }

    public void Dispose()
    {
        AdminState.OnAdminStateChanged -= StateHasChanged;
    }
}
