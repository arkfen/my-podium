@page "/settings/password"
@using Podium.Shared.Services.Api
@using Podium.Shared.Services.State
@inject IPodiumApiClient ApiClient
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>Update Password - Podium</PageTitle>

<div class="settings-form-container">
<a href="/settings" class="back-link">&lsaquo; Back to Settings</a>
    
    <div class="settings-form-card">
        <h2>@(hasPassword ? "Update Password" : "Set Up Password")</h2>
        <p class="subtitle">@(hasPassword ? "Change your account password" : "Create a password for your account")</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        @if (isLoading && profile == null)
        {
            <div class="loading">Loading...</div>
        }
        else if (profile != null)
        {
            @if (!canUpdatePassword)
            {
                <div class="info-box">
                    <p>Password sign-in is not enabled for your account. To set up a password, first enable password sign-in in your <a href="/settings/signin-method">sign-in method settings</a>.</p>
                </div>
            }
            else if (hasPassword)
            {
                @* User has password - update with old password *@
                <div class="auth-form">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" class="form-control" @bind="oldPassword" placeholder="Enter current password" />
                    </div>

                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" class="form-control" @bind="newPassword" placeholder="At least 6 characters" />
                    </div>

                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" class="form-control" @bind="confirmPassword" placeholder="Re-enter new password" />
                    </div>

                    <button class="btn btn-primary w-100" @onclick="UpdateWithOldPassword" disabled="@isLoading">
                        @if (isLoading) { <span>Updating...</span> } else { <span>Update Password</span> }
                    </button>
                </div>
            }
            else
            {
                @* User doesn't have password - set up with OTP *@
                @if (!otpSent)
                {
                    <div class="info-box info">
                        <p>Since you don't have a password yet, we'll send a verification code to your email to confirm your identity.</p>
                    </div>

                    <button class="btn btn-primary w-100" @onclick="SendOtp" disabled="@isLoading">
                        @if (isLoading) { <span>Sending code...</span> } else { <span>Send Verification Code</span> }
                    </button>
                }
                else
                {
                    <div class="auth-form">
                        <p class="text-center">We've sent a verification code to your email.</p>

                        <div class="form-group">
                            <label>Verification Code</label>
                            <input type="text" class="form-control" @bind="otpCode" placeholder="Enter 6-digit code" maxlength="6" />
                        </div>

                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="form-control" @bind="newPassword" placeholder="At least 6 characters" />
                        </div>

                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" class="form-control" @bind="confirmPassword" placeholder="Re-enter password" />
                        </div>

                        <button class="btn btn-primary w-100" @onclick="SetupWithOtp" disabled="@isLoading">
                            @if (isLoading) { <span>Setting up...</span> } else { <span>Set Password</span> }
                        </button>

                        <button class="btn btn-link w-100" @onclick="ResetOtp">Send a new code</button>
                    </div>
                }
            }
        }
    </div>
</div>

@code {
    private UserProfileResponse? profile;
    private string oldPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private string otpCode = "";
    private bool otpSent = false;
    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;

    private bool hasPassword => profile?.HasPassword ?? false;
    private bool canUpdatePassword => profile != null && 
        (profile.PreferredAuthMethod == "Password" || profile.PreferredAuthMethod == "Both" || !hasPassword);

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("/signin");
            return;
        }

        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        isLoading = true;
        try
        {
            var response = await ApiClient.GetMyProfileAsync();
            if (response.Success && response.Data != null)
            {
                profile = response.Data;
            }
            else
            {
                errorMessage = response.Error ?? "Failed to load profile";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SendOtp()
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            var response = await ApiClient.SendPasswordSetupOtpAsync();
            if (response.Success)
            {
                otpSent = true;
                successMessage = "Verification code sent to your email.";
            }
            else
            {
                errorMessage = response.Error ?? "Failed to send verification code.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateWithOldPassword()
    {
        errorMessage = null;
        successMessage = null;

        if (string.IsNullOrWhiteSpace(oldPassword))
        {
            errorMessage = "Please enter your current password.";
            return;
        }

        if (!ValidateNewPassword())
            return;

        await SubmitPasswordUpdate(oldPassword, null);
    }

    private async Task SetupWithOtp()
    {
        errorMessage = null;
        successMessage = null;

        if (string.IsNullOrWhiteSpace(otpCode))
        {
            errorMessage = "Please enter the verification code.";
            return;
        }

        if (!ValidateNewPassword())
            return;

        await SubmitPasswordUpdate(null, otpCode);
    }

    private bool ValidateNewPassword()
    {
        if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters.";
            return false;
        }

        if (newPassword != confirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return false;
        }

        return true;
    }

    private async Task SubmitPasswordUpdate(string? oldPwd, string? otp)
    {
        isLoading = true;
        try
        {
            var request = new UpdatePasswordRequest(oldPwd, otp, newPassword);
            var response = await ApiClient.UpdatePasswordAsync(request);
            if (response.Success)
            {
                successMessage = hasPassword ? "Password updated successfully!" : "Password set up successfully!";
                // Clear form
                oldPassword = "";
                newPassword = "";
                confirmPassword = "";
                otpCode = "";
                otpSent = false;
                // Reload profile
                await LoadProfile();
            }
            else
            {
                errorMessage = response.Error ?? "Failed to update password.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetOtp()
    {
        otpSent = false;
        otpCode = "";
        errorMessage = null;
        successMessage = null;
    }
}
