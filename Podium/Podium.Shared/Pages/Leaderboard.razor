@page "/leaderboard"
@using Podium.Shared.Services.State
@inject IPodiumApiClient ApiClient
@inject AuthStateService AuthState

<PageTitle>Leaderboard - Podium</PageTitle>

<div class="page-container">
    <h1><span class="trophy-icon">&#127942;</span> Leaderboard</h1>

    @if (isLoadingInitial)
    {
        <div class="loading-spinner">
            <p>Loading...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        <div class="leaderboard-filters">
            <div class="filter-group">
                <label for="discipline-select">Discipline:</label>
                <select id="discipline-select" @bind="selectedDisciplineId" @bind:after="OnDisciplineChanged">
                    <option value="">-- Select Discipline --</option>
                    @foreach (var discipline in disciplines)
                    {
                        <option value="@discipline.Id">@discipline.DisplayName</option>
                    }
                </select>
            </div>

            @if (!string.IsNullOrEmpty(selectedDisciplineId) && series.Count > 0)
            {
                <div class="filter-group">
                    <label for="series-select">Series:</label>
                    <select id="series-select" @bind="selectedSeriesId" @bind:after="OnSeriesChanged">
                        <option value="">-- Select Series --</option>
                        @foreach (var s in series)
                        {
                            <option value="@s.Id">@s.DisplayName</option>
                        }
                    </select>
                </div>
            }

            @if (!string.IsNullOrEmpty(selectedSeriesId) && seasons.Count > 0)
            {
                <div class="filter-group">
                    <label for="season-select">Season:</label>
                    <select id="season-select" @bind="selectedSeasonId" @bind:after="OnSeasonChanged">
                        <option value="">-- Select Season --</option>
                        @foreach (var season in seasons)
                        {
                            <option value="@season.Id">@season.Name (@season.Year)</option>
                        }
                    </select>
                </div>
            }
        </div>

        @if (isLoadingLeaderboard)
        {
            <div class="loading-spinner">
                <p>Loading leaderboard...</p>
            </div>
        }
        else if (string.IsNullOrEmpty(selectedSeasonId))
        {
            <div class="alert alert-info">
                <p>Please select a discipline, series, and season to view the leaderboard.</p>
            </div>
        }
        else if (leaderboard.Count == 0)
        {
            <div class="alert alert-info">
                No predictions have been made yet for this season.
            </div>
        }
        else
        {
            <div class="leaderboard-table">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            @if (ShouldShowBestResultsColumn())
                            {
                                <th>@GetBestResultsColumnHeader()</th>
                            }
                            <th>Total</th>
                            <th>Predictions</th>
                            <th>Exact</th>
                            <th>1 Off</th>
                            <th>2 Off</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{int rank = 0;}
                        @foreach (var entry in leaderboard)
                        {
                            rank++;
                            <tr>
                                <td>
                                    <span class="rank-badge @GetRankClass(rank)">@rank</span>
                                </td>
                                <td><strong>@entry.Username</strong></td>
                                @if (ShouldShowBestResultsColumn())
                                {
                                    <td><strong>@(entry.BestResultsPoints ?? entry.TotalPoints)</strong></td>
                                }
                                <td>@entry.TotalPoints</td>
                                <td>@entry.PredictionsCount</td>
                                <td>@entry.ExactMatches</td>
                                <td>@entry.OneOffMatches</td>
                                <td>@entry.TwoOffMatches</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @* Last Event Results Section *@
            @if (isLoadingLastEvent)
            {
                <div class="last-event-section">
                    <div class="loading-spinner">
                        <p>Loading last event results...</p>
                    </div>
                </div>
            }
            else if (lastEventResult != null)
            {
                <div class="last-event-section">
                    <h2><span class="flag-icon">&#127937;</span> Last Completed Event: @lastEventResult.EventName</h2>
                    <p class="event-date">@lastEventResult.EventDate.ToShortDateString()</p>

                    <div class="actual-result-box">
                        <h3>Actual Podium Result</h3>
                        <div class="podium-display">
                            <div class="podium-position position-1">
                                <div class="position-label"><span class="medal-icon">&#129351;</span> 1st</div>
                                <div class="competitor-name">@lastEventResult.FirstPlaceName</div>
                            </div>
                            <div class="podium-position position-2">
                                <div class="position-label"><span class="medal-icon">&#129352;</span> 2nd</div>
                                <div class="competitor-name">@lastEventResult.SecondPlaceName</div>
                            </div>
                            <div class="podium-position position-3">
                                <div class="position-label"><span class="medal-icon">&#129353;</span> 3rd</div>
                                <div class="competitor-name">@lastEventResult.ThirdPlaceName</div>
                            </div>
                        </div>
                    </div>

                    <div class="user-predictions-section">
                        <h3>Top 10 Predictors</h3>
                        
                        <div class="search-section">
                            <label>Search for a specific user:</label>
                            <div class="search-input-container">
                                <input type="text" 
                                       class="form-control" 
                                       @bind="searchUserQuery" 
                                       @bind:event="oninput"
                                       @onkeyup="SearchLastEventUsers"
                                       placeholder="Type username or email..." />
                                @if (searchingUsers)
                                {
                                    <span class="search-spinner">?</span>
                                }
                            </div>
                            
                            @if (userSearchResults.Any())
                            {
                                <div class="search-results-dropdown">
                                    @foreach (var user in userSearchResults)
                                    {
                                        <div class="search-result-item" @onclick="() => SelectSearchUser(user)">
                                            <strong>@user.Username</strong> (@user.Email)
                                            <span class="points-badge">@user.PointsEarned pts</span>
                                        </div>
                                    }
                                </div>
                            }
                            
                            @if (selectedSearchUsers.Any())
                            {
                                <div class="selected-users-display">
                                    <strong>Showing results for:</strong>
                                    @foreach (var user in selectedSearchUsers)
                                    {
                                        <span class="selected-user-tag">
                                            @user.Username
                                            <button class="clear-user-btn" @onclick="() => RemoveSearchUser(user)">×</button>
                                        </span>
                                    }
                                    <button class="btn-link" @onclick="ClearAllSearchUsers">Clear All</button>
                                </div>
                            }
                        </div>

                        @{
                            var displayedPredictions = selectedSearchUsers.Any() 
                                ? selectedSearchUsers 
                                : lastEventResult.TopPredictions.Take(10).ToList();
                        }

                        @if (displayedPredictions.Any())
                        {
                            <div class="predictions-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>User</th>
                                            <th>Prediction</th>
                                            <th>Points</th>
                                            <th>Submitted</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{int predRank = 0;}
                                        @foreach (var pred in displayedPredictions)
                                        {
                                            predRank++;
                                            <tr>
                                                <td>
                                                    <span class="rank-badge @GetRankClass(predRank)">@predRank</span>
                                                </td>
                                                <td>
                                                    <strong>@pred.Username</strong>
                                                    <div class="user-email">@pred.Email</div>
                                                </td>
                                                <td>
                                                    <div class="prediction-display">
                                                        <span class="pred-position">1st: @pred.FirstPlaceName</span>
                                                        <span class="pred-position">2nd: @pred.SecondPlaceName</span>
                                                        <span class="pred-position">3rd: @pred.ThirdPlaceName</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="points-earned">@pred.PointsEarned</span>
                                                </td>
                                                <td>
                                                    <span class="submission-date">@pred.SubmittedDate.ToShortDateString() @pred.SubmittedDate.ToShortTimeString()</span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="no-results">
                                <p>No predictions found for the selected users.</p>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    }
</div>

@code {
private List<UserStatistics> leaderboard = new();
private List<Discipline> disciplines = new();
private List<Series> series = new();
private List<Season> seasons = new();
    
private string? selectedDisciplineId;
private string? selectedSeriesId;
private string? selectedSeasonId;
    
private bool isLoadingInitial = true;
private bool isLoadingLeaderboard = false;
private bool isLoadingLastEvent = false;
private bool searchingUsers = false;
private string? errorMessage;

// Last event results
private EventResultDetails? lastEventResult = null;
private string searchUserQuery = "";
private List<UserEventPrediction> userSearchResults = new();
private List<UserEventPrediction> selectedSearchUsers = new();
private System.Threading.Timer? searchDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadDisciplines();
        await AutoPopulateWithLatestSeason();
    }

    private async Task LoadDisciplines()
    {
        isLoadingInitial = true;
        errorMessage = null;

        try
        {
            var disciplinesResponse = await ApiClient.GetDisciplinesAsync();
            if (disciplinesResponse.Success && disciplinesResponse.Data != null)
            {
                disciplines = disciplinesResponse.Data;
            }
            else
            {
                errorMessage = disciplinesResponse.Error ?? "Failed to load disciplines.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingInitial = false;
        }
    }

    private async Task AutoPopulateWithLatestSeason()
    {
        // Only auto-populate if user is authenticated
        if (!AuthState.IsAuthenticated || string.IsNullOrEmpty(AuthState.UserId))
            return;

        try
        {
            var response = await ApiClient.GetLatestScoredPredictionFromActiveAsync(AuthState.UserId);
            
            if (response.Success && response.Data != null && 
                !string.IsNullOrEmpty(response.Data.DisciplineId) &&
                !string.IsNullOrEmpty(response.Data.SeriesId) &&
                !string.IsNullOrEmpty(response.Data.SeasonId))
            {
                // Set discipline first
                selectedDisciplineId = response.Data.DisciplineId;
                
                // Load series for this discipline
                var seriesResponse = await ApiClient.GetSeriesAsync(selectedDisciplineId);
                if (seriesResponse.Success && seriesResponse.Data != null)
                {
                    series = seriesResponse.Data;
                }
                
                // Set series
                selectedSeriesId = response.Data.SeriesId;
                
                // Load seasons for this series
                var seasonsResponse = await ApiClient.GetSeasonsAsync(selectedSeriesId);
                if (seasonsResponse.Success && seasonsResponse.Data != null)
                {
                    seasons = seasonsResponse.Data;
                }
                
                // Set season and load leaderboard
                selectedSeasonId = response.Data.SeasonId;
                await LoadLeaderboard();
                await LoadLastEventResult();
            }
        }
        catch (Exception ex)
        {
            // Silently fail - auto-population is not critical
            Console.WriteLine($"Error auto-populating leaderboard: {ex.Message}");
        }
    }

    private async Task OnDisciplineChanged()
    {
        selectedSeriesId = null;
        selectedSeasonId = null;
        series.Clear();
        seasons.Clear();
        leaderboard.Clear();

        if (string.IsNullOrEmpty(selectedDisciplineId))
            return;

        try
        {
            var seriesResponse = await ApiClient.GetSeriesAsync(selectedDisciplineId);
            if (seriesResponse.Success && seriesResponse.Data != null)
            {
                series = seriesResponse.Data;
            }
            else
            {
                errorMessage = seriesResponse.Error ?? "Failed to load series.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task OnSeriesChanged()
    {
        selectedSeasonId = null;
        seasons.Clear();
        leaderboard.Clear();

        if (string.IsNullOrEmpty(selectedSeriesId))
            return;

        try
        {
            var seasonsResponse = await ApiClient.GetSeasonsAsync(selectedSeriesId);
            if (seasonsResponse.Success && seasonsResponse.Data != null)
            {
                seasons = seasonsResponse.Data;
            }
            else
            {
                errorMessage = seasonsResponse.Error ?? "Failed to load seasons.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task OnSeasonChanged()
    {
        leaderboard.Clear();
        lastEventResult = null;
        selectedSearchUsers.Clear();
        userSearchResults.Clear();
        searchUserQuery = "";

        if (string.IsNullOrEmpty(selectedSeasonId))
            return;

        await LoadLeaderboard();
        await LoadLastEventResult();
    }

    private async Task LoadLeaderboard()
    {
        isLoadingLeaderboard = true;
        errorMessage = null;

        try
        {
            var leaderboardResponse = await ApiClient.GetLeaderboardAsync(selectedSeasonId!);
            
            if (leaderboardResponse.Success && leaderboardResponse.Data != null)
            {
                leaderboard = leaderboardResponse.Data;
            }
            else
            {
                errorMessage = leaderboardResponse.Error ?? "Failed to load leaderboard.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingLeaderboard = false;
        }
    }

    private async Task LoadLastEventResult()
    {
        if (string.IsNullOrEmpty(selectedSeasonId))
            return;

        isLoadingLastEvent = true;

        try
        {
            var response = await ApiClient.GetLastEventResultAsync(selectedSeasonId!);
            
            if (response.Success)
            {
                lastEventResult = response.Data;
            }
        }
        catch (Exception ex)
        {
            // Silently fail for last event - it's not critical
            Console.WriteLine($"Error loading last event: {ex.Message}");
        }
        finally
        {
            isLoadingLastEvent = false;
        }
    }

    private void SearchLastEventUsers()
    {
        // Debounce the search
        searchDebounceTimer?.Dispose();
        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await PerformUserSearch();
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task PerformUserSearch()
    {
        if (string.IsNullOrWhiteSpace(searchUserQuery) || searchUserQuery.Length < 2)
        {
            userSearchResults.Clear();
            await InvokeAsync(StateHasChanged);
            return;
        }

        searchingUsers = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var response = await ApiClient.SearchLastEventResultAsync(selectedSeasonId!, searchUserQuery);
            
            if (response.Success && response.Data != null)
            {
                userSearchResults = response.Data;
            }
            else
            {
                userSearchResults.Clear();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching users: {ex.Message}");
            userSearchResults.Clear();
        }
        finally
        {
            searchingUsers = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void SelectSearchUser(UserEventPrediction user)
    {
        if (!selectedSearchUsers.Any(u => u.UserId == user.UserId))
        {
            selectedSearchUsers.Add(user);
            selectedSearchUsers = selectedSearchUsers
                .OrderByDescending(u => u.PointsEarned)
                .ThenBy(u => u.SubmittedDate)
                .ToList();
        }
        
        searchUserQuery = "";
        userSearchResults.Clear();
    }

    private void RemoveSearchUser(UserEventPrediction user)
    {
        selectedSearchUsers.RemoveAll(u => u.UserId == user.UserId);
    }

    private void ClearAllSearchUsers()
    {
        selectedSearchUsers.Clear();
        searchUserQuery = "";
        userSearchResults.Clear();
    }

    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "rank-1",
            2 => "rank-2",
            3 => "rank-3",
            _ => ""
        };
    }

    private bool ShouldShowBestResultsColumn()
    {
        if (string.IsNullOrEmpty(selectedSeasonId))
            return false;

        var selectedSeason = seasons.FirstOrDefault(s => s.Id == selectedSeasonId);
        return selectedSeason?.BestResultsNumber.HasValue == true && 
               selectedSeason.BestResultsNumber.Value > 0;
    }

    private string GetBestResultsColumnHeader()
    {
        if (string.IsNullOrEmpty(selectedSeasonId))
            return "Best Results";

        var selectedSeason = seasons.FirstOrDefault(s => s.Id == selectedSeasonId);
        if (selectedSeason?.BestResultsNumber.HasValue == true && 
            selectedSeason.BestResultsNumber.Value > 0)
        {
            return $"Best {selectedSeason.BestResultsNumber} Results";
        }

        return "Best Results";
    }
}

<style>
    .leaderboard-filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 200px;
        flex: 1;
    }

    .filter-group label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .filter-group select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .filter-group select:hover {
        border-color: #999;
    }

    .filter-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .leaderboard-table {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
    }

    .leaderboard-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .leaderboard-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }

    .leaderboard-table td {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }

    .leaderboard-table tr:hover {
        background-color: #f8f9fa;
    }

    .rank-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        background: #e9ecef;
        color: #495057;
    }

    .rank-badge.rank-1 {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: white;
    }

    .rank-badge.rank-2 {
        background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
        color: white;
    }

    .rank-badge.rank-3 {
        background: linear-gradient(135deg, #CD7F32, #A0522D);
        color: white;
    }

    .trophy-icon {
        font-size: 1.2em;
        margin-right: 8px;
    }

    /* Last Event Results Section */
    .last-event-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        margin-top: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .last-event-section h2 {
        color: #333;
        margin-bottom: 8px;
        font-size: 1.5em;
    }

    .flag-icon {
        font-size: 1.2em;
        margin-right: 8px;
    }

    .medal-icon {
        font-size: 1.2em;
        margin-right: 4px;
    }

    .event-date {
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
    }

    .actual-result-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border-left: 4px solid #007bff;
    }

    .actual-result-box h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2em;
    }

    .podium-display {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .podium-position {
        flex: 1;
        min-width: 150px;
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .position-label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #666;
    }

    .competitor-name {
        font-size: 16px;
        font-weight: 700;
        color: #333;
    }

    .position-1 {
        border-top: 3px solid #FFD700;
    }

    .position-2 {
        border-top: 3px solid #C0C0C0;
    }

    .position-3 {
        border-top: 3px solid #CD7F32;
    }

    .user-predictions-section {
        margin-top: 20px;
    }

    .user-predictions-section h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2em;
    }

    .search-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .search-section label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .search-input-container {
        position: relative;
    }

    .search-input-container input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .search-spinner {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
    }

    .search-results-dropdown {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 5px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .search-result-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .points-badge {
        background: #007bff;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .selected-users-display {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .selected-users-display strong {
        color: #333;
        font-size: 14px;
    }

    .selected-user-tag {
        background: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .clear-user-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .clear-user-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .btn-link {
        background: none;
        border: none;
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
    }

    .btn-link:hover {
        color: #0056b3;
    }

    .predictions-table {
        margin-top: 15px;
        overflow-x: auto;
    }

    .predictions-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .predictions-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
        font-size: 14px;
    }

    .predictions-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }

    .predictions-table tr:hover {
        background-color: #f8f9fa;
    }

    .user-email {
        font-size: 12px;
        color: #666;
        margin-top: 3px;
    }

    .prediction-display {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .pred-position {
        font-size: 13px;
        color: #333;
    }

    .points-earned {
        font-size: 16px;
        font-weight: 700;
        color: #28a745;
    }

    .submission-date {
        font-size: 12px;
        color: #666;
    }

    .no-results {
        text-align: center;
        padding: 30px;
        color: #666;
    }
</style>
