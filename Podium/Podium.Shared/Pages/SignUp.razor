@page "/signup"
@using Podium.Shared.Services.Api
@using Podium.Shared.Services.State
@inject IPodiumApiClient ApiClient
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>Sign Up - Podium</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <h2>Create Your Account</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        @if (!verificationSent)
        {
            <div class="auth-form">
                <div class="form-group">
                    <label>Username <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" @bind="username" placeholder="Your username (can be used to sign in)" maxlength="50" />
                    <small class="form-text text-muted">3-50 characters. Latin letters, numbers, and spaces only. You can use this to sign in.</small>
                </div>

                <div class="form-group">
                    <label>Preferred Sign-In Method <span class="text-danger">*</span></label>
                    <select class="form-control" @bind="preferredAuthMethod">
                        <option value="Both">Both (Password & Email Code)</option>
                        <option value="Password">Password Only</option>
                        <option value="Email">Email Code Only</option>
                    </select>
                </div>

                @if (preferredAuthMethod == "Email" || preferredAuthMethod == "Both")
                {
                    <div class="form-group">
                        <label>Email @(preferredAuthMethod == "Password" ? "(Optional)" : "")<span class='text-danger'>@(preferredAuthMethod == "Password" ? "" : "*")</span></label>
                        <input type="email" class="form-control" @bind="email" placeholder="your@email.com" />
                        @if (preferredAuthMethod != "Password")
                        {
                            <small class="form-text text-muted">Required for email code authentication</small>
                        }
                    </div>
                }
                else
                {
                    <div class="form-group">
                        <label>Email (Optional)</label>
                        <input type="email" class="form-control" @bind="email" placeholder="your@email.com" />
                        <small class="form-text text-muted">Optional for password-only sign-in</small>
                    </div>
                }

                @if (preferredAuthMethod == "Password" || preferredAuthMethod == "Both")
                {
                    <div class="form-group">
                        <label>Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" @bind="password" placeholder="6-100 characters, no spaces" maxlength="100" />
                        <small class="form-text text-muted">Latin letters, numbers, and special characters. No spaces.</small>
                    </div>

                    <div class="form-group">
                        <label>Confirm Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" @bind="confirmPassword" placeholder="Re-enter password" maxlength="100" />
                    </div>
                }

                <button class="btn btn-primary w-100" @onclick="RegisterUser" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Sign Up</span>
                    }
                </button>
            </div>
        }
        else
        {
            <div class="auth-form">
                <p class="text-center">We've sent a verification code to <strong>@email</strong></p>
                <p class="text-center text-muted">Please check your email and enter the code below to complete your registration.</p>

                <div class="form-group">
                    <label>Verification Code</label>
                    <input type="text" class="form-control" @bind="verificationCode" placeholder="000000" maxlength="6" />
                </div>

                <button class="btn btn-primary w-100" @onclick="VerifyAndCompleteRegistration" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Verifying...</span>
                    }
                    else
                    {
                        <span>Verify & Complete Registration</span>
                    }
                </button>

                <button class="btn btn-link w-100" @onclick="ResetVerification">Start over</button>
            </div>
        }

        <div class="auth-footer">
            <p>Already have an account? <a href="/signin">Sign In</a></p>
        </div>
    </div>
</div>

@code {
    private string email = "";
    private string username = "";
    private string password = "";
    private string confirmPassword = "";
    private string preferredAuthMethod = "Both";
    private string verificationCode = "";
    private string tempUserId = "";
    private bool verificationSent = false;
    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;

    private async Task RegisterUser()
    {
        errorMessage = null;
        successMessage = null;

        // Validate username - always required
        if (string.IsNullOrWhiteSpace(username))
        {
            errorMessage = "Username is required.";
            return;
        }

        // Validate based on preferred auth method
        if (preferredAuthMethod == "Email" || preferredAuthMethod == "Both")
        {
            if (string.IsNullOrWhiteSpace(email))
            {
                errorMessage = "Email is required for email code authentication.";
                return;
            }
        }

        if (preferredAuthMethod == "Password" || preferredAuthMethod == "Both")
        {
            if (string.IsNullOrWhiteSpace(password))
            {
                errorMessage = "Password is required for password authentication.";
                return;
            }

            if (password != confirmPassword)
            {
                errorMessage = "Passwords do not match.";
                return;
            }
        }

        isLoading = true;
        try
        {
            // If email is provided, send verification
            if (!string.IsNullOrWhiteSpace(email))
            {
                var response = await ApiClient.SendRegistrationVerificationAsync(email, username, password, preferredAuthMethod);
                if (response.Success && response.Data != null)
                {
                    tempUserId = response.Data.TempUserId;
                    verificationSent = true;
                    successMessage = "Verification code sent! Check your email.";
                }
                else
                {
                    errorMessage = response.Error ?? "Registration failed. Please try again.";
                }
            }
            else
            {
                // No email - register directly (password-only without email)
                var response = await ApiClient.RegisterAsync(email, username, password, preferredAuthMethod);
                if (response.Success && response.Data != null)
                {
                    Navigation.NavigateTo("/signin");
                }
                else
                {
                    errorMessage = response.Error ?? "Registration failed. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task VerifyAndCompleteRegistration()
    {
        errorMessage = null;
        successMessage = null;

        if (string.IsNullOrWhiteSpace(verificationCode))
        {
            errorMessage = "Please enter the verification code.";
            return;
        }

        isLoading = true;
        try
        {
            var response = await ApiClient.VerifyRegistrationAsync(tempUserId, verificationCode);
            if (response.Success && response.Data != null)
            {
                // Registration complete, redirect to sign in
                Navigation.NavigateTo("/signin");
            }
            else
            {
                errorMessage = response.Error ?? "Invalid or expired verification code.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetVerification()
    {
        verificationSent = false;
        verificationCode = "";
        tempUserId = "";
        errorMessage = null;
        successMessage = null;
    }
}

